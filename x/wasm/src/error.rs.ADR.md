# ADR: Implement `x/wasm::error`

## Status
Proposed

## Context

Error handling across the module should use a unified enum so that the keeper,
engine and clients can return consistent results. `wasmd` defines an `errors.go`
file mapping common failure modes.

## Decision

`error.rs` will introduce a `WasmError` enum deriving `thiserror::Error`. It will
cover cases such as invalid code, contract not found, VM execution failures and
serialization issues. `anyhow::Error` will be convertible into `WasmError` to
mirror how `wasmvm` wraps errors coming from the Rust VM. The enum will be used
throughout the engine and keeper modules.

### Error Categories

* **CompileErr** – returned when `cosmwasm_vm` fails to compile uploaded bytecode.
  Include a string description from `VmError` and reference the code ID in
  question. Equivalent to `wasmvm.ErrCompile`.
* **RuntimeErr** – covers execution failures such as panics inside contracts,
  exceeding gas limits or invalid responses. Wrap the underlying `VmError` to
  preserve details.
* **NotFound** – indicates missing contract or code in the keeper. Maps to the
  `ErrNotFound` constant in wasmd.
* **Unauthorized** – thrown when a sender tries to execute or migrate without
  the correct permissions or admin rights.
* **InvalidRequest** – for malformed messages or query payloads that fail JSON
  deserialization.
* **Internal** – catch-all variant for unexpected errors, similar to
  `ErrInternal` in wasmd. Use sparingly and log the underlying issue.

The enum will implement `From<cosmwasm_vm::error::VmError>` so that engine
implementations can use the `?` operator to propagate VM errors directly into
`WasmError`. Additionally `From<anyhow::Error>` will convert generic errors into
`WasmError::Internal`.

## Consequences

A shared error type simplifies result handling and allows mapping to ABCI error
codes in the handler.

## Implementation Guidelines

### Enum Layout

The `WasmError` enum should be declared as `pub` so it can be shared across the
entire crate. Each variant includes a descriptive string and optional context
such as code ID or contract address. For instance:

```rust
pub enum WasmError {
    CompileErr { source: VmError, code_id: u64 },
    RuntimeErr { source: VmError },
    NotFound { kind: &'static str },
    Unauthorized { action: &'static str },
    InvalidRequest { reason: String },
    Internal { reason: String },
}
```

By storing the underlying `VmError` the caller can inspect detailed execution
traces when running in debug mode. This design mirrors how
[`wasmvm`](https://github.com/CosmWasm/wasmvm/blob/main/lib.go) wraps errors with
contextual information for improved logging.

### Conversion Traits

Implement `From<VmError>` for `WasmError` with a mapping table. This keeps the
engine code concise as `?` will automatically turn a `VmError` into our enum.
Provide similar conversions for `std::io::Error`, `serde_json::Error` and other
common failure modes so that higher-level components seldom need to construct a
`WasmError` manually.

### Display and Logging

The `Display` implementation should emit structured messages that include any
relevant IDs or addresses, e.g. "contract 0x1234 not found". Logging macros in
the keeper should output these messages to aid debugging while ensuring that
sensitive information like private keys is never logged.

### Mapping to ABCI Codes

The ABCI handler translates `WasmError` into `tendermint::abci::Code`. We follow
the same mapping as `wasmd`: `NotFound` -> `5`, `Unauthorized` -> `4`,
`InvalidRequest` -> `3`, and `Internal` -> `1`. This mapping should be documented
within the enum file so that future contributors maintain compatibility with
CosmWasm tooling.

### Testing

Unit tests under `tests/error.rs` will verify the conversions from `VmError` and
other error types. Example errors can be generated by executing intentionally
faulty contracts using the real VM, similar to the approach in
[`cosmwasm-vm`](https://github.com/CosmWasm/cosmwasm/tree/main/packages/vm/tests).
Consistency with `wasmd` can be validated by comparing the textual messages
emitted when running the Go implementation against the ones produced here.

## Rationale

By centralizing error handling we reduce duplication across the keeper, engine
and client code. This design also ensures that any new error categories added to
the VM or keeper can be integrated with minimal churn. Referencing patterns from
the existing Cosmos SDK modules helps maintain a predictable developer
experience for those migrating from `wasmd`.

